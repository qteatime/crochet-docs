<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" /><link rel="next" title="The FFI type" href="ffi.html" /><link rel="prev" title="Foreign interfaces" href="index.html" />

    <meta name="generator" content="sphinx-4.1.1, furo 2021.07.05.beta38"/>
        <title>Writing external functions - Crochet 0.12 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/crochet.css" />
    


<style>
  :root {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }

  /* For allowing end-user-specific overrides */
  .override-light {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  .override-dark {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
</style><link media="(prefers-color-scheme: dark)" rel="stylesheet" href="../../_static/pygments_dark.css"></head>
  <body dir="">
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z"/>
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
      stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
      class="feather feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Crochet 0.12 documentation</div></a>
    </div>
    <div class="header-right">
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">Crochet 0.12 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html">
  <input class="sidebar-search" placeholder=Search name="q">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">The Crochet System</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label for="toctree-checkbox-1"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../whats-crochet.html">What’s Crochet?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installing-crochet.html">Installing Crochet</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../structure/index.html">How is Crochet structured?</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label for="toctree-checkbox-2"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../structure/introduction.html">The Crochet universe</a></li>
<li class="toctree-l3"><a class="reference internal" href="../structure/package-configuration.html">Package configuration</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../types/index.html">Data and types</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label for="toctree-checkbox-3"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../types/types-and-data.html">Types and data modelling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../types/hierarchies.html">Hierarchies of types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../types/traits.html">Traits</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../commands/index.html">Commands</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label for="toctree-checkbox-4"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../commands/declaration.html">What are commands?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/signatures.html">Signatures and their uses</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/dispatch.html">Executing commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../commands/why.html">Why are commands …?</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../computing/index.html">Computing with Crochet</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label for="toctree-checkbox-5"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../computing/execution-models.html">Execution models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computing/bindings.html">Naming values</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../computing/intrinsics/index.html">Intrinsic data types</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label for="toctree-checkbox-6"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../computing/intrinsics/gradual.html">Gradual representations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../computing/intrinsics/numbers.html">Numeric models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../computing/intrinsics/text.html">Textual models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../computing/intrinsics/logic.html">Logical models</a></li>
<li class="toctree-l4"><a class="reference internal" href="../computing/intrinsics/functions.html">Program representations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../computing/intrinsics/collections.html">Collections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../computing/application.html">Applying programs and commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computing/using.html">Using data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computing/equality.html">Equality</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computing/branching.html">Branching</a></li>
<li class="toctree-l3"><a class="reference internal" href="../computing/comprehension.html">Working with multiple values</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../effects/index.html">Effects</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label for="toctree-checkbox-7"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../effects/what-are-effects.html">What are effects?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../effects/handlers.html">Effect handlers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../effects/contexts.html">Contextual handlers</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../verification/index.html">Verification</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label for="toctree-checkbox-8"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../verification/examples.html">Example-based testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../verification/contracts.html">Contracts</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">Foreign interfaces</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label for="toctree-checkbox-9"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">Writing external functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="ffi.html">The FFI type</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../security/index.html">Security and capabilities</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label for="toctree-checkbox-10"><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../security/why.html">Why use capabilities?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/groups.html">Capabilities and groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../security/dynamic.html">Dynamic capabilities</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../design-philosophy.html">Annex A: Design philosophy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sociology-and-linguistics.html">Annex B: Sociology and linguistics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <main class="main">
    <div class="content">
      <article role="main">
        <label class="toc-overlay-icon toc-content-icon" for="__toc">
          <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
        </label>
        <div class="section" id="writing-external-functions">
<h1>Writing external functions<a class="headerlink" href="#writing-external-functions" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Crochet’s FFI currently assumes trusted modules, and it’ll
most likely evolve into an Alien-based layer that allows a more nuanced
view of security and permits safe sandboxing at a lower cost.</p>
</div>
<p>The core idea of Crochet’s foreign interfaces is to be able to
define functions in a separate language, and then execute those
functions from Crochet code. Currently the only supported language
is JavaScript.</p>
<div class="section" id="native-modules">
<h2>Native modules<a class="headerlink" href="#native-modules" title="Permalink to this headline">¶</a></h2>
<p>Foreign functions are written in “native modules”, and are loaded
by specifying them in the package configuration. A JavaScript native
module has the following form:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">exports</span><span class="p">.</span><span class="k">default</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ffi</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// native function definitions go here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Within that exported function, the native module can either specify
simple synchronous functions—through the <code class="docutils literal notranslate"><span class="pre">ffi.defun</span></code> method—,
or complex asynchronous functions—through the <code class="docutils literal notranslate"><span class="pre">ffi.defmachine</span></code> method.
A synchronous function here is simply one that just takes some arguments,
does something, and then returns a result.</p>
<p>For example, a native counter could be written as follows:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span>exports.default = (ffi) =&gt; {
  class Counter {
    #value;

    constructor(value) {
      this.#value = value;
    }

    next() {
      return new Counter(this.#value + 1n);
    }

    value() {
      return this.#value;
    }
  }

  ffi.defun("make-counter", (initial_value0) =&gt; {
    const initial_value = ffi.integer_to_bigint(initial_value0);
    const counter = new Counter(initial_value);
    return ffi.box(counter);
  })

  ffi.defun("next", (counter0) =&gt; {
    const counter = ffi.unbox(counter0);
    if (!(counter instanceof Counter)) {
     throw ffi.panic("invalid-type", "expected Counter");
   }
    return ffi.box(counter.next());
  })

  ffi.defun("value", (counter0) =&gt; {
    const counter = ffi.unbox(counter0);
    if (!(counter instanceof Counter)) {
      throw ffi.panic("invalid-type", "expected Counter");
    }
    return ffi.integer(counter.value());
  })
}
</pre></div>
</div>
<p>It could then be used in Crochet as follows:</p>
<div class="highlight-crochet notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> counter<span class="p">(</span>box<span class="p">);</span>

<span class="k">command</span> <span class="o">#</span>counter <span class="nf">with:</span> <span class="p">(</span><span class="nv">Value</span> <span class="k">is</span> integer<span class="p">)</span> <span class="p">=</span>
  <span class="k">foreign</span> make-counter<span class="p">(</span><span class="nv">Value</span><span class="p">);</span>

<span class="k">command</span> counter next <span class="p">=</span>
  <span class="k">foreign</span> next<span class="p">(</span><span class="k">self</span><span class="p">);</span>

<span class="k">command</span> counter value <span class="p">=</span>
  <span class="k">foreign</span> value<span class="p">(</span><span class="k">self</span><span class="p">);</span>
</pre></div>
</div>
<p>The names defind by the native module are only valid within
the package loading it, so there’s no chance of unexpected
collisions. However, it’s still possible to use dots (<code class="docutils literal notranslate"><span class="pre">.</span></code>)
in the name—e.g.: <code class="docutils literal notranslate"><span class="pre">counter.next</span></code> would be a valid foreign
function name. These dots don’t have any special meaning, but
it can make names easier to follow in packages that use a
significant amount of foreign functions.</p>
</div>
<div class="section" id="defun-and-defmachine">
<h2><code class="docutils literal notranslate"><span class="pre">defun</span></code> and <code class="docutils literal notranslate"><span class="pre">defmachine</span></code><a class="headerlink" href="#defun-and-defmachine" title="Permalink to this headline">¶</a></h2>
<p>Functions can be defined with both <code class="docutils literal notranslate"><span class="pre">defun</span></code> and <code class="docutils literal notranslate"><span class="pre">defmachine</span></code>.
One could see <code class="docutils literal notranslate"><span class="pre">defun</span></code> as a simplified form of <code class="docutils literal notranslate"><span class="pre">defmachine</span></code>,
but <code class="docutils literal notranslate"><span class="pre">defun</span></code> has different performance characteristics as well.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">defun</span></code>, the function being called takes over the
execution for as long as it takes to return a value to Crochet,
and it isn’t allowed to execute any Crochet code. This lets
us not bother with having stack frames for native code, which
is significantly cheaper, however it does mean that the Crochet
VM is paused for the duration of the function being executed;
it’s only really suitable for functions that finish quickly.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">defmachine</span></code>, we provide a JavaScript generator
to Crochet. This generator allows us to coordinate with
Crochet code and do asynchronous things, but it also means
that we need to allocate and deal with mixed Crochet and
native frames in the execution stack—this complexity has
a price that can’t be entirely removed.</p>
<p>One use case for <code class="docutils literal notranslate"><span class="pre">defmachine</span></code> is to interact with JavaScript
promises, which are asynchronous. For example, a native
function that fetches data from the network could look
like the following:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="kd">function</span> <span class="nx">fetch_text</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">ffi</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">ffi</span><span class="p">.</span><span class="nx">defmachine</span><span class="p">(</span><span class="s2">"fetch"</span><span class="p">,</span> <span class="kd">function</span><span class="o">*</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="k">yield</span> <span class="nx">ffi</span><span class="p">.</span><span class="k">await</span><span class="p">(</span><span class="nx">fetch_text</span><span class="p">(</span><span class="nx">url</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">})</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ffi.await</span></code> function produces a signal that lets the Crochet VM
resume the current generator once the promise settles. And we send this
signal to the VM by <code class="docutils literal notranslate"><span class="pre">yield</span></code>-ing it. In this sense, the VM runs the
generator step-by-step. At each step, the generator can yield a signal
that causes the VM to perform some work. And it finishes by returning
a value.</p>
<p>Now, the important thing to remember here is that <strong>all</strong> intermediate
values have to be Crochet values—not JavaScript ones. That’s why we
abstract <code class="docutils literal notranslate"><span class="pre">fecth</span></code> into a <code class="docutils literal notranslate"><span class="pre">fetch_text</span></code> function, which ensures that
the promise will be resolved with a Crochet data structure.</p>
</div>
</div>

      </article>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="ffi.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">The FFI type</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="index.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Foreign interfaces</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, Q.
            |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            |
            <a class="muted-link" href="../../_sources/system/ffi/interface.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Writing external functions</a><ul>
<li><a class="reference internal" href="#native-modules">Native modules</a></li>
<li><a class="reference internal" href="#defun-and-defmachine"><code class="docutils literal notranslate"><span class="pre">defun</span></code> and <code class="docutils literal notranslate"><span class="pre">defmachine</span></code></a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </main>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/scripts/main.js"></script>
    </body>
</html>